version: 0.2

phases:
  install:
    runtime-versions:
      ruby: 2.7

  pre_build:
    commands:
      - echo "We are in the pre-build phase."
      - cd /var
      - aws s3 cp s3://eb-rails-server/aws-eb-demo.zip /var
      - mkdir /var/www && cd /var/www
      - unzip ../aws-eb-demo.zip -d .
      - aws s3 cp s3://eb-rails-server/credentials.yml.enc ./config/credentials.yml.enc
      - aws s3 cp s3://eb-rails-server/master.key ./config/master.key

  build:
    commands:
      - echo "We are in the Build phase !"

  post_build:
    commands:
      - echo "We are in the post-build phase."
      - cd /var/www
      - zip -r ../aws-eb-demo-deployable.zip -@ < ./aws/codebuild/include.lst
      # - zip -d ../aws-eb-demo-deployable.zip -@ < ./aws/codebuild/exclude.lst
      - aws s3 cp ../aws-eb-demo-deployable.zip s3://eb-rails-server/aws-eb-demo-deployable.zip
